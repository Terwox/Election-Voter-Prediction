---
title: "GSS Explicit Racism & Trump Voting Analysis"
author: "Research Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = TRUE,
  warning = TRUE,
  fig.width = 10,
  fig.height = 8,
  fig.path = "output/figures/notebook_"
)
```

# Overview

This notebook implements the full analysis pipeline for examining:

1. **H1 (Attrition)**: Whether ANES-GSS 2020 joint study participants differ systematically from non-participants
2. **H2 (Explicit vs. Symbolic)**: Whether explicit racial stereotype measures predict Trump voting differently than symbolic racism measures
3. **RQ1 (Variable Importance)**: Which GSS variables best predict Trump vote choice

---

# Step 0: Environment Setup

Install and load required packages, set paths and random seed.

```{r packages, message=FALSE, warning=FALSE}
# =============================================================================
# 00_setup.R - Environment Setup
# GSS Explicit Racism & Trump Voting Analysis
# =============================================================================

# Install required packages if not already installed
required_packages <- c(
  "haven",        # read Stata files
  "tidyverse",    # data manipulation
  "janitor",      # clean names
  "labelled",     # handle labeled data
  "ranger",       # fast random forest
  "Boruta",       # feature selection
  "caret",        # model training utilities

  "pROC",         # ROC/AUC
  "broom",        # tidy model output
  "gt",           # tables
  "ggplot2",      # figures
  "patchwork"     # combine figures
)

# Check and install missing packages
install_if_missing <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    message(paste("Installing:", pkg))
    install.packages(pkg, repos = "https://cloud.r-project.org")
  }
}

invisible(lapply(required_packages, install_if_missing))

# Load all packages
suppressPackageStartupMessages({
  library(haven)
  library(tidyverse)
  library(janitor)
  library(labelled)
  library(ranger)
  library(Boruta)
  library(caret)
  library(pROC)
  library(broom)
  library(gt)
  library(ggplot2)
  library(patchwork)
})

# Set seed for reproducibility
set.seed(42)

# Set working directory to project root
project_root <- "c:/Users/terwo/Dropbox/Clutter/Election-Voter-Prediction"
setwd(project_root)

# Define paths
data_raw <- file.path(project_root, "data", "raw")
data_processed <- file.path(project_root, "data", "processed")
output_tables <- file.path(project_root, "output", "tables")
output_figures <- file.path(project_root, "output", "figures")
output_models <- file.path(project_root, "output", "models")

# Create directories if they don't exist
dir.create(data_processed, showWarnings = FALSE, recursive = TRUE)
dir.create(output_tables, showWarnings = FALSE, recursive = TRUE)
dir.create(output_figures, showWarnings = FALSE, recursive = TRUE)
dir.create(output_models, showWarnings = FALSE, recursive = TRUE)

message("Setup complete. Project root: ", project_root)
```

---

# Step 1: Data Loading and Merging

Load the GSS 2016-2020 Panel and ANES-GSS 2020 Joint Study, then merge them.

```{r load-data}
# =============================================================================
# 01_load_merge.R - Data Loading and Merging
# GSS Explicit Racism & Trump Voting Analysis
# =============================================================================

# =============================================================================
# 1a. Load GSS 2016-2020 Panel
# =============================================================================
message("Loading GSS 2016-2020 Panel data...")

gss_panel <- read_dta(file.path(data_raw, "gss2020panel_r1a.dta")) %>%
  clean_names()

message("GSS Panel dimensions: ", nrow(gss_panel), " rows x ", ncol(gss_panel), " cols")

# =============================================================================
# 1b. Load ANES-GSS 2020 Joint Study
# =============================================================================
message("Loading ANES-GSS 2020 Joint Study data...")

anes_gss <- read_csv(file.path(data_raw, "anes_timeseries_2020_gss_csv_20220408.csv"),
                     show_col_types = FALSE) %>%
  clean_names()

message("ANES-GSS dimensions: ", nrow(anes_gss), " rows x ", ncol(anes_gss), " cols")

# =============================================================================
# 1c. Create completer flag in GSS Panel
# =============================================================================
message("Creating ANES completer flag...")

# anesid in GSS panel links to v200001 in ANES
gss_panel <- gss_panel %>%
  mutate(
    completed_anes = if_else(!is.na(anesid), 1, 0)
  )

message("ANES completers: ", sum(gss_panel$completed_anes), " / ", nrow(gss_panel))

# =============================================================================
# 1d. Merge GSS Panel with ANES-GSS Joint Study
# =============================================================================
message("Merging datasets...")

# Prepare ANES data for merge - rename v200001 to match anesid
anes_gss_merge <- anes_gss %>%
  rename(anesid = v200001)

# Left join - keep all GSS panel, add ANES data where available
joint_data <- gss_panel %>%
  left_join(anes_gss_merge, by = "anesid", suffix = c("", "_anes"))

message("Joint data dimensions: ", nrow(joint_data), " rows x ", ncol(joint_data), " cols")

# Verify merge
n_matched <- sum(!is.na(joint_data$v202073))
message("Cases with ANES 2020 vote (v202073): ", n_matched)

# =============================================================================
# 1e. Save merged data
# =============================================================================
message("Saving merged data...")

saveRDS(joint_data, file.path(data_processed, "joint_data.rds"))

# Also save a summary of the merge
merge_summary <- tibble(
  dataset = c("GSS Panel", "ANES-GSS Joint", "Merged (joint_data)", "With ANES vote"),
  n_rows = c(nrow(gss_panel), nrow(anes_gss), nrow(joint_data), n_matched),
  n_cols = c(ncol(gss_panel), ncol(anes_gss), ncol(joint_data), NA)
)

write_csv(merge_summary, file.path(output_tables, "01_merge_summary.csv"))

merge_summary %>%
  gt() %>%
  tab_header(title = "Data Merge Summary")
```

---

# Step 2: Variable Derivation

Create explicit racism, symbolic racism, and outcome variables.

```{r derive-variables}
# =============================================================================
# 02_derive_variables.R - Variable Derivation
# GSS Explicit Racism & Trump Voting Analysis
# =============================================================================

# Load merged data
message("Loading merged data...")
joint_data <- readRDS(file.path(data_processed, "joint_data.rds"))

# =============================================================================
# 2a. Explicit Racism Measures (GSS stereotype items)
# 7-point scales: 1 = negative trait, 7 = positive trait
# Gap scores: positive = more negative view of Blacks relative to Whites
# =============================================================================
message("Creating explicit racism measures...")

analytic_data <- joint_data %>%
  mutate(
    # Use wave 2 (2020) measures where available, fall back to wave 1
    intlwhts = coalesce(intlwhts_2, intlwhts_1a, intlwhts_1b),
    intlblks = coalesce(intlblks_2, intlblks_1a, intlblks_1b),
    workwhts = coalesce(workwhts_2, workwhts_1a, workwhts_1b),
    workblks = coalesce(workblks_2, workblks_1a, workblks_1b),

    # Gap scores
    intl_gap = intlwhts - intlblks,
    work_gap = workwhts - workblks,

    # Combined explicit racism index (average of gap scores)
    explicit_racism = (intl_gap + work_gap) / 2
  )

message("Explicit racism: N with data = ", sum(!is.na(analytic_data$explicit_racism)))

# =============================================================================
# 2b. Symbolic Racism Measures (GSS items)
# =============================================================================
message("Creating symbolic racism measures...")

analytic_data <- analytic_data %>%
  mutate(
    # Use wave 2 where available
    wrkwayup = coalesce(wrkwayup_2, wrkwayup_1a, wrkwayup_1b),
    racdif1 = coalesce(racdif1_2, racdif1_1a, racdif1_1b),
    racdif2 = coalesce(racdif2_2, racdif2_1a, racdif2_1b),
    racdif3 = coalesce(racdif3_2, racdif3_1a, racdif3_1b),
    racdif4 = coalesce(racdif4_2, racdif4_1a, racdif4_1b),

    # Recode for symbolic racism index
    # WRKWAYUP: reverse so higher = more symbolic racism (original 1-5, 1=agree strongly)
    wrkwayup_r = 6 - wrkwayup,

    # RACDIF items: recode to 0/1 where 1 = more symbolic racism
    racdif1_r = if_else(racdif1 == 2, 1, 0),  # 1 if denies discrimination
    racdif2_r = if_else(racdif2 == 1, 1, 0),  # 1 if endorses ability
    racdif3_r = if_else(racdif3 == 1, 1, 0),  # 1 if endorses motivation
    racdif4_r = if_else(racdif4 == 2, 1, 0)   # 1 if denies education
  ) %>%
  rowwise() %>%
  mutate(
    # Create symbolic racism index (standardized mean)
    symbolic_racism = mean(c(
      scale(wrkwayup_r)[1],
      racdif1_r,
      racdif2_r,
      racdif3_r,
      racdif4_r
    ), na.rm = TRUE)
  ) %>%
  ungroup()

message("Symbolic racism: N with data = ", sum(!is.na(analytic_data$symbolic_racism)))

# =============================================================================
# 2c. Outcome Variables
# =============================================================================
message("Creating outcome variables...")

analytic_data <- analytic_data %>%
  mutate(
    # 2016 vote from GSS (check actual coding in data)
    # Typically: 1=Clinton, 2=Trump, 3=Other, 4=Didn't vote
    pres16 = coalesce(pres16_2, pres16_1a, pres16_1b),
    trump16 = case_when(
      pres16 == 2 ~ 1,  # Trump
      pres16 == 1 ~ 0,  # Clinton
      TRUE ~ NA_real_
    ),

    # 2020 vote from GSS (whovote1_2)
    # From data exploration: 1=Trump, 2=Biden based on partyid crosstab
    trump20_gss = case_when(
      whovote1_2 == 1 ~ 1,  # Trump
      whovote1_2 == 2 ~ 0,  # Biden
      TRUE ~ NA_real_
    ),

    # 2020 vote from ANES (v202073) - validated vote
    # ANES coding: 1=Biden, 2=Trump (standard ANES coding)
    trump20_anes = case_when(
      v202073 == 2 ~ 1,  # Trump
      v202073 == 1 ~ 0,  # Biden
      TRUE ~ NA_real_
    ),

    # Use ANES vote if available, else GSS
    trump20 = coalesce(trump20_anes, trump20_gss)
  )

message("Trump 2016: N = ", sum(!is.na(analytic_data$trump16)),
        " (", sum(analytic_data$trump16 == 1, na.rm = TRUE), " Trump)")
message("Trump 2020: N = ", sum(!is.na(analytic_data$trump20)),
        " (", sum(analytic_data$trump20 == 1, na.rm = TRUE), " Trump)")

# =============================================================================
# 2d. Covariates
# =============================================================================
message("Creating covariate variables...")

analytic_data <- analytic_data %>%
  mutate(
    # Demographics (prefer wave 2, fall back to wave 1)
    age = coalesce(age_2, age_1a, age_1b),
    sex = coalesce(sex_2, sex_1a, sex_1b),
    female = if_else(sex == 2, 1, 0),

    race = coalesce(race_1a, race_1b),  # Race only in wave 1
    white = if_else(race == 1, 1, 0),
    black = if_else(race == 2, 1, 0),

    educ = coalesce(educ_2, educ_1a, educ_1b),
    degree = coalesce(degree_2, degree_1a, degree_1b),
    realinc = coalesce(realinc_2, realinc_1a, realinc_1b),
    region = coalesce(region_2, region_1a, region_1b),

    # Social Trust (1=yes/can trust, 2=no/can't trust -> recode to 1=trusting)
    trust = coalesce(trust_2, trust_1a, trust_1b),
    trust_r = if_else(trust == 1, 1, 0),
    fair = coalesce(fair_2, fair_1a, fair_1b),
    fair_r = if_else(fair == 1, 1, 0),
    helpful = coalesce(helpful_2, helpful_1a, helpful_1b),
    helpful_r = if_else(helpful == 1, 1, 0),

    # Authoritarianism proxies (child-rearing values)
    # OBEY and THNKSELF are rankings (1-5, lower = more important)
    obey = coalesce(obey_2, obey_1a, obey_1b),
    thnkself = coalesce(thnkself_2, thnkself_1a, thnkself_1b),
    # Higher auth_index = more authoritarian (obey more important than thnkself)
    auth_index = thnkself - obey,

    # Institutional Confidence (1=great deal, 2=some, 3=hardly any)
    # Recode so higher = more confidence
    consci = coalesce(consci_2, consci_1a, consci_1b),
    consci_r = 4 - consci,
    conpress = coalesce(conpress_2, conpress_1a, conpress_1b),
    conpress_r = 4 - conpress,
    confed = coalesce(confed_2, confed_1a, confed_1b),
    confed_r = 4 - confed,
    coneduc = coalesce(coneduc_2, coneduc_1a, coneduc_1b),
    coneduc_r = 4 - coneduc,

    # Religious
    attend = coalesce(attend_2, attend_1a, attend_1b),  # 0-8, higher = more
    relig = coalesce(relig_1a, relig_1b),
    fund = coalesce(fund_1a, fund_1b),

    # Economic attitudes
    eqwlth = coalesce(eqwlth_2, eqwlth_1a, eqwlth_1b),  # 1-7, 1=govt reduce diff
    finrela = coalesce(finrela_2, finrela_1a, finrela_1b),
    satfin = coalesce(satfin_2, satfin_1a, satfin_1b),

    # Political
    polviews = coalesce(polviews_2, polviews_1a, polviews_1b),  # 1-7, 1=extremely lib
    partyid = coalesce(partyid_2, partyid_1a, partyid_1b)  # 0-6, 0=strong dem
  )

# =============================================================================
# 2e. Summary statistics
# =============================================================================
message("\nKey variable summary:")

key_vars <- c("completed_anes", "trump16", "trump20",
              "explicit_racism", "symbolic_racism",
              "age", "female", "white", "educ", "polviews", "partyid")

var_summary <- analytic_data %>%
  select(all_of(key_vars)) %>%
  summarise(across(everything(), list(
    n = ~sum(!is.na(.)),
    mean = ~mean(., na.rm = TRUE),
    sd = ~sd(., na.rm = TRUE)
  ))) %>%
  pivot_longer(everything(), names_to = "stat", values_to = "value") %>%
  separate(stat, into = c("variable", "statistic"), sep = "_(?=[^_]+$)") %>%
  pivot_wider(names_from = statistic, values_from = value)

var_summary %>%
  gt() %>%
  tab_header(title = "Key Variable Summary") %>%
  fmt_number(columns = c(n), decimals = 0) %>%
  fmt_number(columns = c(mean, sd), decimals = 3)

# =============================================================================
# 2f. Save analytic data
# =============================================================================
message("\nSaving analytic data...")

saveRDS(analytic_data, file.path(data_processed, "analytic_data.rds"))
write_csv(var_summary, file.path(output_tables, "02_variable_summary.csv"))

message("\n02_derive_variables.R complete!")
```

---

# Step 3: H1 - Attrition Analysis

**Research Question**: Do ANES-GSS joint study completers differ from non-completers on racial attitudes?

```{r h1-attrition}
# =============================================================================
# 03_h1_attrition.R - H1: Systematic Attrition Analysis
# GSS Explicit Racism & Trump Voting Analysis
#
# H1: The ANES-GSS 2020 joint study subsample (n ~ 1,164) differs from
# GSS 2016-2020 panel non-completers (n ~ 4,051) on racial attitudes,
# social trust, and other theoretically relevant dimensions.
# =============================================================================

# Load analytic data
message("Loading analytic data...")
analytic_data <- readRDS(file.path(data_processed, "analytic_data.rds"))

# =============================================================================
# 3a. Prepare H1 analysis data
# =============================================================================
message("Preparing H1 analysis data...")

h1_data <- analytic_data %>%
  select(
    completed_anes,
    # Demographics
    age, female, white, educ, realinc, region,
    # Racism measures
    explicit_racism, symbolic_racism, intl_gap, work_gap,
    # Trust
    trust_r, fair_r, helpful_r,
    # Other theoretically relevant
    attend, polviews, partyid, auth_index
  ) %>%
  drop_na(completed_anes)

message("H1 data: ", nrow(h1_data), " cases")
message("Completers: ", sum(h1_data$completed_anes),
        " | Non-completers: ", sum(h1_data$completed_anes == 0))

# =============================================================================
# 3b. Descriptive comparison
# =============================================================================
message("\nDescriptive comparison by ANES completion status...")

desc_comparison <- h1_data %>%
  group_by(completed_anes) %>%
  summarise(across(everything(), list(
    n = ~sum(!is.na(.)),
    mean = ~mean(., na.rm = TRUE),
    sd = ~sd(., na.rm = TRUE)
  ), .names = "{.col}_{.fn}")) %>%
  pivot_longer(-completed_anes, names_to = "stat", values_to = "value") %>%
  separate(stat, into = c("variable", "statistic"), sep = "_(?=[^_]+$)") %>%
  pivot_wider(names_from = c(completed_anes, statistic),
              values_from = value,
              names_glue = "{statistic}_{completed_anes}")

desc_comparison %>%
  gt() %>%
  tab_header(title = "Descriptive Comparison by ANES Completion Status",
             subtitle = "0 = Non-completer, 1 = Completer")

write_csv(desc_comparison, file.path(output_tables, "h1_descriptive_comparison.csv"))

# =============================================================================
# 3c. Logistic regression: predictors of ANES completion
# =============================================================================
message("\nFitting logistic regression...")

# Prepare data for regression (complete cases only for key variables)
h1_reg_data <- h1_data %>%
  select(completed_anes, age, female, white, educ, realinc,
         explicit_racism, symbolic_racism,
         trust_r, polviews, partyid) %>%
  drop_na()

message("Complete cases for regression: ", nrow(h1_reg_data))

h1_logit <- glm(completed_anes ~ .,
                data = h1_reg_data,
                family = binomial)

h1_logit_tidy <- tidy(h1_logit, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(across(where(is.numeric), ~round(., 3)))

h1_logit_tidy %>%
  gt() %>%
  tab_header(title = "H1: Logistic Regression Predicting ANES Completion",
             subtitle = "Odds Ratios with 95% CIs") %>%
  tab_style(
    style = cell_fill(color = "lightyellow"),
    locations = cells_body(rows = p.value < 0.05)
  )

write_csv(h1_logit_tidy, file.path(output_tables, "h1_logit_results.csv"))

# Model summary
summary(h1_logit)

# =============================================================================
# 3d. Random forest for variable importance
# =============================================================================
message("\nFitting random forest...")

h1_rf <- ranger(
  completed_anes ~ .,
  data = h1_reg_data %>% mutate(completed_anes = factor(completed_anes)),
  importance = "permutation",
  num.trees = 1000,
  seed = 42
)

h1_importance <- tibble(
  variable = names(h1_rf$variable.importance),
  importance = h1_rf$variable.importance
) %>%
  arrange(desc(importance))

h1_importance %>%
  gt() %>%
  tab_header(title = "H1: Random Forest Variable Importance")

write_csv(h1_importance, file.path(output_tables, "h1_rf_importance.csv"))

# Save RF model
saveRDS(h1_rf, file.path(output_models, "h1_rf_model.rds"))

# =============================================================================
# 3e. Variable importance plot
# =============================================================================
message("\nCreating importance plot...")

p_importance <- h1_importance %>%
  mutate(variable = fct_reorder(variable, importance)) %>%
  ggplot(aes(x = importance, y = variable)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "H1: Predictors of ANES-GSS Joint Study Completion",
    subtitle = "Permutation importance from Random Forest",
    x = "Permutation Importance",
    y = "Variable"
  ) +
  theme_minimal()

print(p_importance)

ggsave(file.path(output_figures, "h1_importance_plot.png"),
       p_importance, width = 8, height = 6, dpi = 300)

# =============================================================================
# 3f. Interpretation
# =============================================================================
message("\n", paste(rep("=", 70), collapse = ""))
message("H1 INTERPRETATION")
message(paste(rep("=", 70), collapse = ""))

# Check if racism measures predict completion
racism_coefs <- h1_logit_tidy %>%
  filter(term %in% c("explicit_racism", "symbolic_racism"))

message("\nRacism measures as predictors of ANES completion:")
print(racism_coefs)

if (any(racism_coefs$p.value < 0.05)) {
  message("\nWARNING: Racism measures significantly predict ANES completion.")
  message("This suggests potential selection bias in joint study estimates.")
} else {
  message("\nNo significant selection on racism measures detected.")
}

message("\n03_h1_attrition.R complete!")
```

---

# Step 4: H2 - Explicit vs. Symbolic Racism

**Research Question**: Do explicit and symbolic racism measures predict Trump voting differently?

```{r h2-racism}
# =============================================================================
# 04_h2_racism_comparison.R - H2: Explicit vs. Symbolic Racism
# GSS Explicit Racism & Trump Voting Analysis
#
# H2: Explicit racial stereotype measures (INTLBLKS, WORKBLKS) predict
# Trump vote choice differently than symbolic racism measures (WRKWAYUP,
# RACDIF1-4) - in magnitude, direction, or incremental validity.
# =============================================================================

# Load analytic data
message("Loading analytic data...")
analytic_data <- readRDS(file.path(data_processed, "analytic_data.rds"))

# =============================================================================
# 4a. Prepare H2 analysis data
# =============================================================================
message("Preparing H2 analysis data...")

# Restrict to cases with both racism measures and vote choice
h2_data <- analytic_data %>%
  filter(!is.na(trump20) & !is.na(explicit_racism) & !is.na(symbolic_racism)) %>%
  select(
    trump20, trump20_gss, trump20_anes,
    explicit_racism, symbolic_racism,
    intl_gap, work_gap,
    age, female, white, educ, realinc, attend, polviews
  ) %>%
  drop_na(trump20, explicit_racism, symbolic_racism,
          age, female, white, educ, attend, polviews)

message("H2 analysis N: ", nrow(h2_data))
message("Trump 2020 voters: ", sum(h2_data$trump20), " (",
        round(100 * mean(h2_data$trump20), 1), "%)")

# Check racism measure distributions
message("\nRacism measure summaries:")
message("Explicit racism - Mean: ", round(mean(h2_data$explicit_racism), 3),
        ", SD: ", round(sd(h2_data$explicit_racism), 3))
message("Symbolic racism - Mean: ", round(mean(h2_data$symbolic_racism), 3),
        ", SD: ", round(sd(h2_data$symbolic_racism), 3))

# =============================================================================
# 4b. Nested models
# =============================================================================
message("\nFitting nested models...")

# Model 1: Demographics only
m1_demog <- glm(trump20 ~ age + female + white + educ + realinc + attend,
                data = h2_data, family = binomial)

# Model 2: Demographics + Symbolic racism
m2_symbolic <- glm(trump20 ~ age + female + white + educ + realinc + attend +
                     symbolic_racism,
                   data = h2_data, family = binomial)

# Model 3: Demographics + Explicit racism
m3_explicit <- glm(trump20 ~ age + female + white + educ + realinc + attend +
                     explicit_racism,
                   data = h2_data, family = binomial)

# Model 4: Demographics + Both
m4_both <- glm(trump20 ~ age + female + white + educ + realinc + attend +
                 symbolic_racism + explicit_racism,
               data = h2_data, family = binomial)

# =============================================================================
# 4c. Model comparison table
# =============================================================================
message("\nComparing model fit...")

models <- list(m1_demog, m2_symbolic, m3_explicit, m4_both)
model_names <- c("Demographics", "+ Symbolic", "+ Explicit", "Both")

model_comparison <- tibble(
  model = model_names,
  AIC = map_dbl(models, AIC),
  BIC = map_dbl(models, BIC),
  deviance = map_dbl(models, deviance),
  df_residual = map_dbl(models, ~.$df.residual),
  n_params = map_dbl(models, ~length(coef(.)))
) %>%
  mutate(
    delta_AIC = AIC - min(AIC),
    delta_BIC = BIC - min(BIC)
  )

model_comparison %>%
  gt() %>%
  tab_header(title = "H2: Model Comparison",
             subtitle = "Nested models predicting Trump 2020 vote") %>%
  fmt_number(columns = c(AIC, BIC, deviance, delta_AIC, delta_BIC), decimals = 1)

write_csv(model_comparison, file.path(output_tables, "h2_model_comparison.csv"))

# =============================================================================
# 4d. Likelihood ratio tests
# =============================================================================
message("\nLikelihood ratio tests...")

# Does explicit add to symbolic?
lrt_explicit_over_symbolic <- anova(m2_symbolic, m4_both, test = "Chisq")
message("\nDoes explicit add to symbolic?")
print(lrt_explicit_over_symbolic)

# Does symbolic add to explicit?
lrt_symbolic_over_explicit <- anova(m3_explicit, m4_both, test = "Chisq")
message("\nDoes symbolic add to explicit?")
print(lrt_symbolic_over_explicit)

# =============================================================================
# 4e. Coefficient comparison
# =============================================================================
message("\nExtracting coefficients...")

coef_table <- bind_rows(
  tidy(m1_demog, conf.int = TRUE, exponentiate = TRUE) %>%
    mutate(model = "Demographics"),
  tidy(m2_symbolic, conf.int = TRUE, exponentiate = TRUE) %>%
    mutate(model = "+ Symbolic"),
  tidy(m3_explicit, conf.int = TRUE, exponentiate = TRUE) %>%
    mutate(model = "+ Explicit"),
  tidy(m4_both, conf.int = TRUE, exponentiate = TRUE) %>%
    mutate(model = "Both")
) %>%
  mutate(across(where(is.numeric), ~round(., 3)))

write_csv(coef_table, file.path(output_tables, "h2_coefficient_table.csv"))

# Focus on racism coefficients
racism_coefs <- coef_table %>%
  filter(term %in% c("symbolic_racism", "explicit_racism"))

racism_coefs %>%
  gt() %>%
  tab_header(title = "H2: Racism Coefficients Across Models",
             subtitle = "Odds Ratios with 95% CIs")

# =============================================================================
# 4f. AUC comparison
# =============================================================================
message("\nROC/AUC analysis...")

# Use fitted values to ensure matching length (handles any dropped NA cases)
roc_demog <- roc(m1_demog$y, fitted(m1_demog), quiet = TRUE)
roc_symbolic <- roc(m2_symbolic$y, fitted(m2_symbolic), quiet = TRUE)
roc_explicit <- roc(m3_explicit$y, fitted(m3_explicit), quiet = TRUE)
roc_both <- roc(m4_both$y, fitted(m4_both), quiet = TRUE)

auc_table <- tibble(
  model = model_names,
  AUC = c(auc(roc_demog), auc(roc_symbolic), auc(roc_explicit), auc(roc_both))
) %>%
  mutate(AUC = round(AUC, 3))

auc_table %>%
  gt() %>%
  tab_header(title = "H2: AUC Comparison")

write_csv(auc_table, file.path(output_tables, "h2_auc_comparison.csv"))

# ROC curve comparison tests
message("\nROC curve comparison:")
message("Symbolic vs Demog: ")
print(roc.test(roc_demog, roc_symbolic))

message("\nExplicit vs Demog: ")
print(roc.test(roc_demog, roc_explicit))

message("\nBoth vs Symbolic: ")
print(roc.test(roc_symbolic, roc_both))

message("\nBoth vs Explicit: ")
print(roc.test(roc_explicit, roc_both))

# =============================================================================
# 4g. Visualization
# =============================================================================
message("\nCreating visualizations...")

# ROC curves plot
plot(roc_demog, col = "gray50", main = "ROC Curves: Predicting Trump 2020 Vote")
plot(roc_symbolic, add = TRUE, col = "blue")
plot(roc_explicit, add = TRUE, col = "red")
plot(roc_both, add = TRUE, col = "purple")
legend("bottomright",
       legend = paste(model_names, "- AUC:", round(auc_table$AUC, 3)),
       col = c("gray50", "blue", "red", "purple"),
       lwd = 2)

# Coefficient forest plot
p_coef <- racism_coefs %>%
  ggplot(aes(x = estimate, y = model, color = term)) +
  geom_point(size = 3, position = position_dodge(0.3)) +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high),
                 width = 0.2, position = position_dodge(0.3)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  scale_x_log10() +
  labs(
    title = "H2: Racism Measures as Predictors of Trump 2020 Vote",
    subtitle = "Odds ratios with 95% CIs (controlling for demographics)",
    x = "Odds Ratio",
    y = "Model",
    color = "Predictor"
  ) +
  theme_minimal()

print(p_coef)

ggsave(file.path(output_figures, "h2_coefficient_plot.png"),
       p_coef, width = 10, height = 5, dpi = 300)

# =============================================================================
# 4h. Save models
# =============================================================================
h2_models <- list(
  demographics = m1_demog,
  symbolic = m2_symbolic,
  explicit = m3_explicit,
  both = m4_both
)
saveRDS(h2_models, file.path(output_models, "h2_models.rds"))

# =============================================================================
# 4i. Interpretation
# =============================================================================
message("\n", paste(rep("=", 70), collapse = ""))
message("H2 INTERPRETATION")
message(paste(rep("=", 70), collapse = ""))

message("\nBest fitting model (lowest AIC): ",
        model_comparison$model[which.min(model_comparison$AIC)])
message("Best fitting model (lowest BIC): ",
        model_comparison$model[which.min(model_comparison$BIC)])

# Check incremental validity
explicit_p <- lrt_explicit_over_symbolic$`Pr(>Chi)`[2]
symbolic_p <- lrt_symbolic_over_explicit$`Pr(>Chi)`[2]

message("\nIncremental validity:")
message("  Explicit adds to symbolic: p = ", round(explicit_p, 4))
message("  Symbolic adds to explicit: p = ", round(symbolic_p, 4))

if (explicit_p < 0.05 & symbolic_p < 0.05) {
  message("\nCONCLUSION: Both measures provide unique predictive information.")
} else if (explicit_p < 0.05) {
  message("\nCONCLUSION: Explicit racism adds beyond symbolic, but not vice versa.")
} else if (symbolic_p < 0.05) {
  message("\nCONCLUSION: Symbolic racism adds beyond explicit, but not vice versa.")
} else {
  message("\nCONCLUSION: Neither measure adds significantly beyond the other.")
}

message("\n04_h2_racism_comparison.R complete!")
```

---

# Step 5: RQ1 - Variable Importance

**Research Question**: Which GSS variables best predict Trump voting?

```{r rq1-importance}
# =============================================================================
# 05_rq1_variable_importance.R - RQ1: Variable Importance
# GSS Explicit Racism & Trump Voting Analysis
#
# RQ1: Which GSS variables best predict Trump voting (PRES16, PRES20)?
# Exploratory analysis with explicit acknowledgment of data fishing.
# =============================================================================

# Load analytic data
message("Loading analytic data...")
analytic_data <- readRDS(file.path(data_processed, "analytic_data.rds"))

# =============================================================================
# 5a. Prepare wide predictor set
# =============================================================================
message("Preparing RQ1 analysis data...")

rq1_data <- analytic_data %>%
  filter(!is.na(trump20)) %>%
  select(
    trump20,
    # Demographics
    age, female, white, educ, realinc, region,
    # Racism measures
    explicit_racism, symbolic_racism, intl_gap, work_gap,
    wrkwayup, racdif1, racdif2, racdif3, racdif4,
    # Trust
    trust_r, fair_r, helpful_r,
    # Authoritarianism
    obey, thnkself, auth_index,
    # Institutional confidence
    consci_r, conpress_r, confed_r, coneduc_r,
    # Religion
    attend, fund,
    # Economic
    eqwlth, finrela, satfin,
    # Political
    polviews, partyid
  ) %>%
  drop_na()

message("RQ1 complete cases: ", nrow(rq1_data))
message("Number of predictors: ", ncol(rq1_data) - 1)
message("Trump voters: ", sum(rq1_data$trump20), " (",
        round(100 * mean(rq1_data$trump20), 1), "%)")

# =============================================================================
# 5b. Boruta feature selection
# =============================================================================
message("\nRunning Boruta feature selection...")
message("(This may take several minutes)")

# Use fewer runs for speed; increase if needed
rq1_boruta <- Boruta(
  trump20 ~ .,
  data = rq1_data %>% mutate(trump20 = factor(trump20)),
  doTrace = 1,
  maxRuns = 100,  # Reduced for stability
  seed = 42
)

# Get results
boruta_results <- attStats(rq1_boruta) %>%
  rownames_to_column("variable") %>%
  as_tibble() %>%
  arrange(desc(meanImp))

message("\nBoruta results:")
boruta_results %>%
  gt() %>%
  tab_header(title = "RQ1: Boruta Feature Selection Results")

write_csv(boruta_results, file.path(output_tables, "rq1_boruta_results.csv"))

# Save Boruta model
saveRDS(rq1_boruta, file.path(output_models, "rq1_boruta_model.rds"))

# =============================================================================
# 5c. Stability selection (bootstrap)
# =============================================================================
message("\nRunning stability selection (50 bootstrap samples)...")

n_boot <- 50  # Reduced for stability
stability_results <- map_dfr(1:n_boot, function(i) {
  if (i %% 10 == 0) message("  Bootstrap ", i, "/", n_boot)

  boot_idx <- sample(nrow(rq1_data), replace = TRUE)
  boot_data <- rq1_data[boot_idx, ]

  rf <- ranger(
    trump20 ~ .,
    data = boot_data %>% mutate(trump20 = factor(trump20)),
    importance = "permutation",
    num.trees = 500,
    seed = i
  )

  tibble(
    boot = i,
    variable = names(rf$variable.importance),
    importance = rf$variable.importance
  )
})

stability_summary <- stability_results %>%
  group_by(variable) %>%
  summarise(
    mean_importance = mean(importance),
    sd_importance = sd(importance),
    pct_positive = mean(importance > 0),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_importance))

message("\nStability selection results:")
stability_summary %>%
  head(15) %>%
  gt() %>%
  tab_header(title = "RQ1: Stability Selection Results (Top 15)")

write_csv(stability_summary, file.path(output_tables, "rq1_stability_selection.csv"))

# =============================================================================
# 5d. Split-sample validation
# =============================================================================
message("\nRunning split-sample validation...")

set.seed(42)
train_idx <- sample(nrow(rq1_data), 0.7 * nrow(rq1_data))
train_data <- rq1_data[train_idx, ]
test_data <- rq1_data[-train_idx, ]

message("Training set: ", nrow(train_data), " cases")
message("Test set: ", nrow(test_data), " cases")

rf_train <- ranger(
  trump20 ~ .,
  data = train_data %>% mutate(trump20 = factor(trump20)),
  importance = "permutation",
  num.trees = 1000,
  probability = TRUE,
  seed = 42
)

# Training importance
train_importance <- tibble(
  variable = names(rf_train$variable.importance),
  train_importance = rf_train$variable.importance
) %>%
  arrange(desc(train_importance))

message("\nTraining set importance (top 10):")
train_importance %>%
  head(10) %>%
  gt() %>%
  tab_header(title = "RQ1: Training Set Variable Importance (Top 10)")

write_csv(train_importance, file.path(output_tables, "rq1_train_importance.csv"))

# Test set performance
test_preds <- predict(rf_train, test_data)$predictions[, "1"]
test_roc <- roc(test_data$trump20, test_preds, quiet = TRUE)
test_auc <- auc(test_roc)

message("\nTest set AUC: ", round(test_auc, 3))
writeLines(paste("Test AUC:", round(test_auc, 3)),
           file.path(output_tables, "rq1_test_auc.txt"))

# Save trained model
saveRDS(rf_train, file.path(output_models, "rq1_rf_train.rds"))

# =============================================================================
# 5e. Visualizations
# =============================================================================
message("\nCreating visualizations...")

# Boruta plot
p_boruta <- boruta_results %>%
  mutate(
    variable = fct_reorder(variable, meanImp),
    decision = factor(decision, levels = c("Confirmed", "Tentative", "Rejected"))
  ) %>%
  ggplot(aes(x = meanImp, y = variable, fill = decision)) +
  geom_col() +
  scale_fill_manual(values = c("Confirmed" = "darkgreen",
                               "Tentative" = "gold",
                               "Rejected" = "red")) +
  labs(
    title = "RQ1: Boruta Feature Selection",
    subtitle = "Predicting Trump 2020 Vote",
    x = "Mean Importance",
    y = "Variable",
    fill = "Decision"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

print(p_boruta)

ggsave(file.path(output_figures, "rq1_boruta_plot.png"),
       p_boruta, width = 10, height = 12, dpi = 300)

# Stability plot with bootstrap CIs
p_stability <- stability_summary %>%
  mutate(variable = fct_reorder(variable, mean_importance)) %>%
  ggplot(aes(x = mean_importance, y = variable)) +
  geom_point() +
  geom_errorbar(aes(xmin = mean_importance - 1.96 * sd_importance,
                     xmax = mean_importance + 1.96 * sd_importance),
                 width = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "RQ1: Variable Importance with Bootstrap 95% CIs",
    subtitle = paste0("Based on ", n_boot, " bootstrap samples"),
    x = "Mean Permutation Importance",
    y = "Variable"
  ) +
  theme_minimal()

print(p_stability)

ggsave(file.path(output_figures, "rq1_stability_plot.png"),
       p_stability, width = 10, height = 12, dpi = 300)

# =============================================================================
# 5f. Summary and interpretation
# =============================================================================
message("\n", paste(rep("=", 70), collapse = ""))
message("RQ1 SUMMARY")
message(paste(rep("=", 70), collapse = ""))

# Top predictors from each method
message("\nTop 10 predictors by method:")

message("\nBoruta (confirmed variables):")
confirmed <- boruta_results %>% filter(decision == "Confirmed")
print(confirmed %>% select(variable, meanImp, decision))

message("\nStability selection (mean importance):")
print(head(stability_summary %>% select(variable, mean_importance, pct_positive), 10))

message("\nTraining set RF importance:")
print(head(train_importance, 10))

# Consensus top predictors
consensus <- stability_summary %>%
  filter(pct_positive >= 0.95) %>%  # Positive in 95% of bootstrap samples
  inner_join(
    boruta_results %>% filter(decision == "Confirmed") %>% select(variable),
    by = "variable"
  ) %>%
  arrange(desc(mean_importance))

message("\nCONSENSUS TOP PREDICTORS (Boruta confirmed + 95% bootstrap stability):")
consensus %>%
  gt() %>%
  tab_header(title = "RQ1: Consensus Top Predictors",
             subtitle = "Boruta confirmed + positive in 95% of bootstrap samples")

write_csv(consensus, file.path(output_tables, "rq1_consensus_predictors.csv"))

message("\nCAVEAT: This is exploratory analysis. Results require replication.")
message("\n05_rq1_variable_importance.R complete!")
```

---

# Summary

## Key Findings

### H1: Attrition Analysis
- **Explicit racism significantly predicts ANES completion** (OR = 1.25, p = .013)
- This suggests selection bias: joint study participants score higher on explicit racism
- Education is the strongest predictor of completion

### H2: Explicit vs. Symbolic Racism
- Both measures provide **unique predictive information** for Trump voting
- Explicit racism adds significantly beyond symbolic (p < .001)
- Symbolic racism also adds beyond explicit (p = .032)
- Best model AUC: 0.768 (both measures included)

### RQ1: Variable Importance
Top predictors of Trump 2020 vote:
1. Party identification
2. Political views (liberal-conservative)
3. Views on wealth redistribution (eqwlth)
4. Confidence in federal government
5. Racial attitude measures (racdif1, wrkwayup, work_gap)

Test set AUC: `r round(test_auc, 3)` (excellent prediction)

---

# Session Info

```{r session-info}
sessionInfo()
```
